<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수단비 단어 챌린지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            overflow: hidden;
        }
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .screen.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(118, 75, 162, 0.8);
        }
        .btn-primary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .option-btn:hover {
            transform: scale(1.02);
            border-color: #764ba2;
        }
        .correct {
            animation: correct-answer 0.5s ease;
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
        }
        .incorrect {
            animation: incorrect-answer 0.5s ease;
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
        }
        @keyframes correct-answer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes incorrect-answer {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        #leaderboard-list li:nth-child(1) .rank { background-color: #ffd700; color: #fff; }
        #leaderboard-list li:nth-child(2) .rank { background-color: #c0c0c0; color: #fff; }
        #leaderboard-list li:nth-child(3) .rank { background-color: #cd7f32; color: #fff; }
        .freq-info {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .freq-info.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s;
            z-index: 40;
        }
        .modal {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            animation: fadeIn 0.3s;
        }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-2xl p-6 sm:p-8 text-slate-800 overflow-hidden relative" style="height: 95vh; max-height: 800px;">
        
        <div id="start-screen" class="screen active flex-col h-full">
            <div class="text-center">
                <h1 class="text-4xl sm:text-5xl font-bold font-poppins gradient-text">수단비</h1>
                <h2 class="text-2xl sm:text-3xl font-bold mt-1">단어 챌린지</h2>
                <p class="text-slate-500 mt-4">수능 1등급 어휘력, 30초 안에 증명하라!</p>
            </div>

            <div class="my-4">
                <p id="challenge-week-info" class="text-center text-purple-600 font-semibold mb-4"></p>
                <div id="nickname-container">
                    <label id="nickname-label" for="start-nickname-input" class="text-center block font-bold mb-2">닉네임을 입력하세요!</label>
                    <input type="text" id="start-nickname-input" placeholder="도전할 닉네임 (2~10자)" minlength="2" maxlength="10" class="w-full p-3 border-2 border-slate-300 rounded-md text-center focus:border-purple-500 focus:ring-purple-500 transition">
                </div>
            </div>
            
            <div class="flex-grow my-2 overflow-y-auto">
                <h3 class="text-xl font-bold text-center mb-3">🏆 명예의 전당</h3>
                <ul id="leaderboard-list" class="space-y-2">
                    <li class="text-center text-slate-400 p-4">랭킹을 불러오는 중...</li>
                </ul>
            </div>

            <div id="start-button-container" class="w-full">
                <button id="start-btn" class="w-full py-4 text-xl font-bold text-white rounded-lg btn-primary">
                    도전 시작!
                </button>
                <button id="share-for-chance-btn" class="w-full py-4 text-xl font-bold bg-[#FEE500] text-[#191919] rounded-lg hover:opacity-90 transition hidden items-center justify-center">
                     <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 3C7.029 3 3 6.12 3 10.018C3 12.33 4.348 14.37 6.428 15.657L5.21 20.211C5.122 20.548 5.421 20.845 5.76 20.755L11.234 19.311C11.484 19.333 11.74 19.344 12 19.344C16.971 19.344 21 16.224 21 12.326C21 8.428 16.971 5.308 12 5.308C12 4.195 12 3 12 3Z" fill="#191919"/></svg>
                    공유하고 기회 얻기!
                </button>
            </div>
        </div>

        <div id="game-screen" class="screen flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <div class="font-bold text-lg">점수: <span id="score" class="font-poppins">0</span></div>
                <div class="font-bold text-lg font-poppins bg-slate-100 rounded-full px-4 py-1">
                    <span id="timer">30</span>초
                </div>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 100%; transition: width 1s linear;"></div>
            </div>
            <div class="flex-grow flex flex-col items-center justify-center">
                <p id="word" class="text-5xl sm:text-6xl font-bold font-poppins mb-6"></p>
                <div id="freq-info-container" class="h-12 mb-2">
                </div>
                <div id="options" class="w-full space-y-3">
                </div>
            </div>
        </div>
        
        <div id="end-screen" class="screen flex-col h-full justify-center text-center">
            <h2 class="text-2xl font-bold text-slate-500">게임 종료!</h2>
            <p class="text-lg mt-2">최종 점수</p>
            <p id="final-score" class="text-8xl font-bold font-poppins my-4 gradient-text"></p>
            
            <div id="email-form-container" class="w-full bg-slate-100 p-4 rounded-lg">
                <p class="font-bold mb-2">랭킹이 자동 등록되었습니다!<br/>출시 알림 & 경품 이벤트에 참여하세요!</p>
                <input type="email" id="email-input" placeholder="이메일 남기기 (선택사항)" class="w-full p-3 border-2 border-slate-300 rounded-md text-center mt-2 focus:border-purple-500 focus:ring-purple-500 transition">
                <button id="submit-email-btn" class="w-full py-3 mt-3 text-lg font-bold text-white rounded-lg btn-primary">이메일 제출</button>
            </div>

            <div class="mt-4 flex space-x-2">
                <button id="kakao-share-btn-direct" class="flex-1 py-3 bg-[#FEE500] text-[#191919] font-bold rounded-lg hover:opacity-90 transition flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 3C7.029 3 3 6.12 3 10.018C3 12.33 4.348 14.37 6.428 15.657L5.21 20.211C5.122 20.548 5.421 20.845 5.76 20.755L11.234 19.311C11.484 19.333 11.74 19.344 12 19.344C16.971 19.344 21 16.224 21 12.326C21 8.428 16.971 5.308 12 5.308C12 4.195 12 3 12 3Z" fill="#191919"/></svg>
                    카톡으로 공유하기
                </button>
                <button id="restart-btn" class="flex-1 py-3 bg-slate-200 text-slate-800 font-bold rounded-lg hover:bg-slate-300 transition">다시 도전</button>
            </div>
        </div>

    </div>

    <div id="alert-modal-backdrop" class="modal-backdrop"></div>
    <div id="alert-modal" class="modal w-11/12 max-w-sm bg-white rounded-2xl shadow-lg p-6 text-center">
        <p id="alert-modal-message" class="text-lg font-semibold mb-6"></p>
        <button id="close-alert-modal-btn" class="w-full py-3 text-lg font-bold text-white rounded-lg btn-primary">확인</button>
    </div>

    <script src="/__/firebase/9.6.1/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-auth-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-functions-compat.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script type="module">
        const auth = firebase.auth();
        const db = firebase.firestore();
        const app = firebase.app();
        const functions = app.functions('asia-northeast3');  

        const isNicknameAvailable = functions.httpsCallable('isNicknameAvailable');
        const getKakaoKey = functions.httpsCallable('getKakaoKey');

        const ui = {
            screens: { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), end: document.getElementById('end-screen') },
            startBtn: document.getElementById('start-btn'),
            shareForChanceBtn: document.getElementById('share-for-chance-btn'),
            startNicknameInput: document.getElementById('start-nickname-input'),
            nicknameContainer: document.getElementById('nickname-container'),
            nicknameLabel: document.getElementById('nickname-label'),
            scoreEl: document.getElementById('score'),
            timerEl: document.getElementById('timer'),
            progressBar: document.getElementById('progress-bar'),
            wordEl: document.getElementById('word'),
            optionsEl: document.getElementById('options'),
            freqInfoContainer: document.getElementById('freq-info-container'),
            finalScoreEl: document.getElementById('final-score'),
            emailFormContainer: document.getElementById('email-form-container'),
            emailInput: document.getElementById('email-input'),
            submitEmailBtn: document.getElementById('submit-email-btn'),
            restartBtn: document.getElementById('restart-btn'),
            leaderboardList: document.getElementById('leaderboard-list'),
            challengeWeekInfoEl: document.getElementById('challenge-week-info'),
            alertModal: { backdrop: document.getElementById('alert-modal-backdrop'), modal: document.getElementById('alert-modal'), message: document.getElementById('alert-modal-message'), closeBtn: document.getElementById('close-alert-modal-btn') }
        };

        let score, timer, timerInterval, currentWordIndex, nickname, gameStartTime, currentChallengeWeek;
        let shuffledWords = [];
        let isAnswerable = true;
        
        let audioCtx;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.warn('Web Audio API is not supported in this browser');
        }

        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);

            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            } else { // incorrect
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            }
            
            oscillator.start(audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2);
            oscillator.stop(audioCtx.currentTime + 0.2);
        }

        function showCustomAlert(message) {
            ui.alertModal.message.textContent = message;
            ui.alertModal.modal.style.display = 'block';
            ui.alertModal.backdrop.style.display = 'block';
        }

        function closeCustomAlert() {
            ui.alertModal.modal.style.display = 'none';
            ui.alertModal.backdrop.style.display = 'none';
        }

        function switchScreen(screenName) {
            Object.values(ui.screens).forEach(screen => screen.classList.remove('active'));
            ui.screens[screenName].classList.add('active');
        }
        
        function adjustFontSize(element, initialFontSize, minFontSize = 10, padding = 20) {
            element.style.fontSize = `${initialFontSize}px`;
            let currentFontSize = initialFontSize;
            const containerWidth = element.parentElement.clientWidth - padding;

            while (element.scrollWidth > containerWidth && currentFontSize > minFontSize) {
                currentFontSize--;
                element.style.fontSize = `${currentFontSize}px`;
            }
        }

        async function initGame() {
            nickname = ui.startNicknameInput.value.trim();
            if (ui.startNicknameInput.disabled) {
                // Nickname is fixed
            } else {
                if (nickname.length < 2 || nickname.length > 10) {
                    showCustomAlert('닉네임은 2자 이상 10자 이하로 입력해주세요!');
                    return;
                }
                ui.startBtn.disabled = true;
                ui.startBtn.textContent = '닉네임 확인 중...';
                try {
                    const result = await isNicknameAvailable({ nickname: nickname });
                    if (!result.data.isAvailable) {
                        showCustomAlert('이미 사용 중인 닉네임입니다. 다른 닉네임을 사용해주세요!');
                        await checkPlayChance();
                        return;
                    }
                    localStorage.setItem('sudanbiNickname', nickname);
                } catch (error) {
                    console.error("Nickname check error:", error);
                    showCustomAlert(error.message || '닉네임 확인 중 오류가 발생했습니다.');
                    await checkPlayChance();
                    return;
                }
            }

            ui.startBtn.disabled = true;
            ui.startBtn.textContent = '문제 로딩 중...';

            try {
                const wordsForThisWeek = await getWordsForCurrentWeek();
                if (!wordsForThisWeek || wordsForThisWeek.length === 0) {
                    showCustomAlert(`이번 ${currentChallengeWeek}주차 챌린지 단어가 없습니다. 관리자에게 문의해주세요.`);
                    await checkPlayChance();
                    return;
                }
                score = 0;
                timer = 30;
                currentWordIndex = 0;
                ui.scoreEl.textContent = score;
                ui.timerEl.textContent = timer;
                shuffledWords = [...wordsForThisWeek].sort(() => 0.5 - Math.random());
                gameStartTime = Date.now();
                switchScreen('game');
                loadNextWord();
                startTimer();
            } catch (error) {
                console.error("Game start error:", error);
                showCustomAlert(error.message || '오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
                await checkPlayChance();
            }
        }
        
        function getCurrentChallengeWeek() {
            // ❗️ 변경점: 시즌 시작일을 OBT 시작일인 2025년 9월 1일로 변경
            const SEASON_1_START_DATE = new Date('2025-09-01T00:00:00+09:00'); // 시즌1 시작일 (월요일)
            const now = new Date();
            const timeDiff = now.getTime() - SEASON_1_START_DATE.getTime();
            
            if (timeDiff < 0) return 1;
            
            const weekDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24 * 7));
            return weekDiff + 1;
        }

        async function getWordsForCurrentWeek() {
            currentChallengeWeek = getCurrentChallengeWeek();
            const weekKey = `Week ${currentChallengeWeek}`;
            try {
                const seasonDocRef = db.collection("seasons").doc("season1");
                const seasonDoc = await seasonDocRef.get();
                if (seasonDoc.exists) {
                    const allWeeksData = seasonDoc.data();
                    return allWeeksData[weekKey] || [];
                }
                console.warn("Season 1 document does not exist.");
                return [];
            } catch (error) {
                console.error("Error getting words: ", error);
                throw new Error("단어 목록을 불러오는 데 실패했습니다.");
            }
        }

        function startTimer() {
            ui.progressBar.style.width = '100%';
            ui.progressBar.style.transition = `width ${timer}s linear`;
            requestAnimationFrame(() => { ui.progressBar.style.width = '0%'; });
            timerInterval = setInterval(() => {
                timer--;
                ui.timerEl.textContent = timer;
                if (timer <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function loadNextWord() {
            isAnswerable = true;
            ui.freqInfoContainer.innerHTML = '';
            if (currentWordIndex >= shuffledWords.length) {
                currentWordIndex = 0;
                shuffledWords.sort(() => 0.5 - Math.random());
            }
            const currentWord = shuffledWords[currentWordIndex];
            ui.wordEl.textContent = currentWord.단어;
            
            const baseFontSize = window.innerWidth < 640 ? 48 : 60;
            adjustFontSize(ui.wordEl, baseFontSize, 24);

            ui.optionsEl.innerHTML = '';
            const options = [currentWord.정답, currentWord.오답1, currentWord.오답2, currentWord.오답3];
            options.sort(() => 0.5 - Math.random()).forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'w-full p-4 border-2 border-slate-200 rounded-lg text-xl transition duration-200 option-btn';
                button.onclick = () => handleAnswer(button, option, currentWord.정답, currentWord.역대_빈도);
                ui.optionsEl.appendChild(button);
                
                adjustFontSize(button, 20, 14, 32);
            });
            currentWordIndex++;
        }

        function handleAnswer(button, selectedOption, correctAnswer, freqData) {
            if (!isAnswerable) return;
            isAnswerable = false;
            if (selectedOption === correctAnswer) {
                playSound('correct');
                score += 10;
                ui.scoreEl.textContent = score;
                button.classList.add('correct');
            } else {
                playSound('incorrect');
                button.classList.add('incorrect');
                Array.from(ui.optionsEl.children).forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }
            const freqText = `📊 역대 ${freqData}회 출제`;
            ui.freqInfoContainer.innerHTML = `<div class="freq-info text-center bg-slate-100 p-2 rounded-md text-slate-600 font-semibold">${freqText}</div>`;
            setTimeout(() => {
                const freqInfoEl = ui.freqInfoContainer.querySelector('.freq-info');
                if (freqInfoEl) freqInfoEl.classList.add('visible');
            }, 10);

            setTimeout(() => {
                if (timer > 0) {
                    loadNextWord();
                }
            }, 800);
        }

        async function endGame() {
            clearInterval(timerInterval);
            ui.progressBar.style.transition = 'none';
            ui.finalScoreEl.textContent = score;
            const elapsedTime = Date.now() - gameStartTime;
            const user = auth.currentUser;
            if (!user) {
                switchScreen('end');
                return;
            }

            try {
                const attemptRef = db.collection('attempts').doc(user.uid);
                await attemptRef.set({
                    playCount: firebase.firestore.FieldValue.increment(1),
                    lastPlayDate: new Date().toISOString().slice(0, 10)
                }, { merge: true });
            } catch (error) {
                console.error("Error updating attempts:", error);
            }

            const userScoreRef = db.collection("scores").doc(user.uid);
            try {
                const docSnap = await userScoreRef.get();
                if (docSnap.exists) {
                    const existingData = docSnap.data();
                    const isNewHighScore = score > (existingData.score || 0) || (score === existingData.score && elapsedTime < (existingData.elapsedTime || Infinity));
                    if (isNewHighScore) {
                        await userScoreRef.update({
                            score: score,
                            elapsedTime: elapsedTime,
                            name: nickname,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                } else {
                    await userScoreRef.set({
                        uid: user.uid,
                        name: nickname,
                        score: score,
                        elapsedTime: elapsedTime,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error("Error saving score: ", error);
                showCustomAlert('점수 저장에 실패했습니다. Firestore 보안 규칙을 확인해주세요.');
            }
            switchScreen('end');
        }

        async function submitEmail() {
             const email = ui.emailInput.value.trim();
            if (!email) {
                showCustomAlert('이벤트에 참여하시려면 이메일을 입력해주세요!');
                return;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showCustomAlert('올바른 이메일 형식을 입력해주세요.');
                return;
            }
            ui.submitEmailBtn.disabled = true;
            ui.submitEmailBtn.textContent = '제출 중...';
            try {
                const user = auth.currentUser;
                if (!user) {
                    showCustomAlert('사용자 인증 정보가 없습니다. 새로고침 후 다시 시도해주세요.');
                    ui.submitEmailBtn.disabled = false;
                    return;
                }
                
                await db.collection("emails").doc(user.uid).set({
                    name: nickname,
                    email: email,
                    score: score,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showCustomAlert('이벤트 참여가 완료되었습니다!');
                ui.emailFormContainer.style.display = 'none';

            } catch (error) {
                console.error("Email submission error:", error);
                if (error.code === 'permission-denied') {
                    showCustomAlert('이미 이벤트에 참여하셨습니다!');
                    ui.emailFormContainer.style.display = 'none';
                } else {
                    showCustomAlert('이메일 제출에 실패했습니다. 다시 시도해주세요.');
                    ui.submitEmailBtn.disabled = false;
                }
                ui.submitEmailBtn.textContent = '이메일 제출';
            }
        }

        function displayLeaderboard(scores) {
            ui.leaderboardList.innerHTML = '';
            if (!scores || scores.length === 0) {
                ui.leaderboardList.innerHTML = '<li class="text-center text-slate-400 p-4">아직 등록된 점수가 없어요.<br>첫 번째 챔피언이 되어보세요!</li>';
                return;
            }
            scores.forEach((data, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-slate-100 p-3 rounded-lg';
                const timeDisplay = data.elapsedTime ? `<span class="text-xs text-slate-500 font-poppins">${(data.elapsedTime / 1000).toFixed(2)}초</span>` : '';
                li.innerHTML = `
                    <div class="flex items-center">
                        <span class="rank font-bold text-sm bg-slate-300 text-slate-600 rounded-full w-6 h-6 flex items-center justify-center mr-3">${index + 1}</span>
                        <span class="font-semibold text-slate-700">${data.name}</span>
                    </div>
                    <div class="text-right">
                        <span class="font-bold font-poppins text-purple-600">${data.score}점</span>
                        ${timeDisplay}
                    </div>
                `;
                ui.leaderboardList.appendChild(li);
            });
        }

        function subscribeToLeaderboard() {
            // ❗️ 변경점: 주차별 필터링을 제거하여 종합 랭킹으로 변경
            const q = db.collection("scores")
                        .orderBy("score", "desc")
                        .orderBy("elapsedTime", "asc").limit(10);
            
            q.onSnapshot((querySnapshot) => {
                const scores = [];
                querySnapshot.forEach((doc) => { scores.push(doc.data()); });
                displayLeaderboard(scores);
            }, (error) => {
                console.error("Leaderboard subscription error: ", error);
                let message = '랭킹을 불러오는 데 실패했습니다.<br>잠시 후 다시 시도해주세요.';
                if (error.code === 'permission-denied') {
                    message = '랭킹을 볼 권한이 없습니다.<br>Firestore 보안 규칙을 확인해주세요.';
                }
                ui.leaderboardList.innerHTML = `<li class="text-center text-slate-400 p-4 text-red-500">${message}</li>`;
            });
        }
        
        async function shareToKakao(isForChance = false) {
            if (!Kakao.isInitialized()) {
                try {
                    const result = await getKakaoKey();
                    const kakaoKey = result.data.key;
                    Kakao.init(kakaoKey);
                } catch (error) {
                    console.error("카카오 키를 가져오는 데 실패했습니다:", error);
                    showCustomAlert('공유 기능을 준비하는 중 오류가 발생했습니다.');
                    return;
                }
            }
            
            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: '수단비 단어 챌린지',
                    description: isForChance ? `친구야, 같이 수능 영단어 퀴즈 풀자!` : `${nickname}님이 ${score}점을 기록했어요! 당신의 어휘력에 도전하세요!`,
                    imageUrl: 'https://cdn.imweb.me/upload/S20250512bc351e1543759/78f771da220ea.png',
                    link: { mobileWebUrl: window.location.href, webUrl: window.location.href, },
                },
                buttons: [{ title: '게임하러 가기', link: { mobileWebUrl: window.location.href, webUrl: window.location.href }}],
                success: async function() {
                    if (isForChance) {
                        const user = auth.currentUser;
                        if(user) {
                            try {
                                const attemptRef = db.collection('attempts').doc(user.uid);
                                await attemptRef.set({ hasSharedToday: true }, { merge: true });
                                showCustomAlert('공유 완료! 추가 도전 기회를 얻었습니다.');
                                await checkPlayChance();
                            } catch (error) {
                                console.error("Error updating share status:", error);
                            }
                        }
                    }
                },
                fail: function(error) {
                    console.log(error);
                    if (isForChance) {
                        showCustomAlert('공유가 취소되었어요. 기회를 얻으려면 공유를 완료해주세요!');
                    }
                }
            });
        }

        function checkStoredNickname() {
            const storedNickname = localStorage.getItem('sudanbiNickname');
            if (storedNickname) {
                ui.startNicknameInput.value = storedNickname;
                ui.startNicknameInput.disabled = true;
                ui.nicknameLabel.textContent = `${storedNickname}님, 다시 도전하세요!`;
            }
        }

        function setChallengeWeekInfo() {
            currentChallengeWeek = getCurrentChallengeWeek();
            const month = new Date().getMonth() + 1;
            ui.challengeWeekInfoEl.textContent = `🏆 ${month}월 ${currentChallengeWeek}주차 챌린지 진행 중 🏆`;
        }
        
        async function checkPlayChance() {
            const user = auth.currentUser;
            if (!user) return;

            const today = new Date().toISOString().slice(0, 10);
            const attemptRef = db.collection('attempts').doc(user.uid);
            const docSnap = await attemptRef.get();

            let hasPlayedToday = false;
            let hasSharedToday = false;

            if (docSnap.exists) {
                const data = docSnap.data();
                if (data.lastPlayDate === today) {
                    hasPlayedToday = (data.playCount || 0) > 0;
                    hasSharedToday = data.hasSharedToday || false;
                } else {
                    // 날짜가 바뀌었으면 공유 기록 초기화
                    await attemptRef.set({ hasSharedToday: false }, { merge: true });
                }
            }

            if (!hasPlayedToday || hasSharedToday) {
                ui.startBtn.classList.remove('hidden');
                ui.shareForChanceBtn.classList.add('hidden');
                ui.startBtn.disabled = false;
                ui.startBtn.textContent = '도전 시작!';
            } else {
                ui.startBtn.classList.add('hidden');
                ui.shareForChanceBtn.classList.remove('hidden');
            }
        }


        ui.startBtn.addEventListener('click', initGame);
        ui.restartBtn.addEventListener('click', () => {
             switchScreen('start');
             checkPlayChance();
        });
        ui.submitEmailBtn.addEventListener('click', submitEmail);
        ui.alertModal.closeBtn.addEventListener('click', closeCustomAlert);
        ui.alertModal.backdrop.addEventListener('click', closeCustomAlert);
        ui.shareForChanceBtn.addEventListener('click', () => shareToKakao(true));
        document.getElementById('kakao-share-btn-direct').addEventListener('click', () => shareToKakao(false));

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("Anonymous user signed in:", user.uid);
                
                try {
                    const emailDocRef = db.collection("emails").doc(user.uid);
                    const docSnap = await emailDocRef.get();
                    if (docSnap.exists()) {
                        ui.emailFormContainer.style.display = 'none';
                    } else {
                        ui.emailFormContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Error checking email record:", error);
                }

                setChallengeWeekInfo();
                subscribeToLeaderboard();
                checkStoredNickname();
                await checkPlayChance();
            } else {
                auth.signInAnonymously().catch((error) => console.error("Anonymous sign-in failed:", error));
            }
        });
    </script>
</body>
</html>

