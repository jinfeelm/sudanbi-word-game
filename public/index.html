<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ë‹¨ë¹„ ë‹¨ì–´ ì±Œë¦°ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .gradient-text { background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .screen { display: none; animation: fadeIn 0.5s ease-in-out; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(118, 75, 162, 0.4), 0 4px 6px -2px rgba(118, 75, 162, 0.2); }
        .btn-primary:disabled { background: #d1d5db; cursor: not-allowed; transform: none; box-shadow: none; }
        .option-btn:hover { transform: scale(1.02); border-color: #764ba2; }
        .correct { animation: correct-answer 0.5s ease; background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .incorrect { animation: incorrect-answer 0.5s ease; background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        @keyframes correct-answer { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes incorrect-answer { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        #leaderboard-list li:nth-child(1) .rank { background-color: #ffd700; color: #fff; }
        #leaderboard-list li:nth-child(2) .rank { background-color: #c0c0c0; color: #fff; }
        #leaderboard-list li:nth-child(3) .rank { background-color: #cd7f32; color: #fff; }
        .freq-info { opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .freq-info.visible { opacity: 1; transform: translateY(0); }
        .modal-backdrop { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); animation: fadeIn 0.3s; z-index: 40; }
        .modal { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 50; animation: fadeIn 0.3s; }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-2xl p-6 sm:p-8 text-slate-800 flex flex-col" style="height: 95vh; max-height: 800px;">

        <div id="start-screen" class="screen active flex-col h-full">
            <div class="text-center">
                <h1 class="text-4xl sm:text-5xl font-bold font-poppins gradient-text">ìˆ˜ë‹¨ë¹„</h1>
                <h2 class="text-2xl sm:text-3xl font-bold mt-1">ë‹¨ì–´ ì±Œë¦°ì§€</h2>
                <p class="text-slate-500 mt-4">ìˆ˜ëŠ¥ 1ë“±ê¸‰ ì–´íœ˜ë ¥, 30ì´ˆ ì•ˆì— ì¦ëª…í•˜ë¼!</p>
            </div>

            <div class="my-4">
                <p id="challenge-week-info" class="text-center text-purple-600 font-semibold mb-4"></p>
                <div id="nickname-container">
                    <label id="nickname-label" for="start-nickname-input" class="text-center block font-bold mb-2">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!</label>
                    <input type="text" id="start-nickname-input" placeholder="ë„ì „í•  ë‹‰ë„¤ì„ (2~10ì)" minlength="2" maxlength="10" class="w-full p-3 border-2 border-slate-300 rounded-md text-center focus:border-purple-500 focus:ring-purple-500 transition">
                </div>
            </div>
            
            <div class="flex-grow my-2 overflow-y-auto">
                <h3 class="text-xl font-bold text-center mb-3">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
                <ul id="leaderboard-list" class="space-y-2">
                    <li class="text-center text-slate-400 p-4">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
                </ul>
            </div>
            
            <div id="start-button-container" class="w-full flex flex-col justify-center pt-4" style="min-height: 96px;">
                <button id="start-btn" class="w-full py-4 text-xl font-bold text-white rounded-lg btn-primary">
                    ë„ì „ ì‹œì‘!
                </button>
                <button id="share-for-chance-btn" class="w-full py-4 text-xl font-bold bg-[#FEE500] text-[#191919] rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-transform duration-200 hidden items-center justify-center">
                    <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 3C7.029 3 3 6.12 3 10.018C3 12.33 4.348 14.37 6.428 15.657L5.21 20.211C5.122 20.548 5.421 20.845 5.76 20.755L11.234 19.311C11.484 19.333 11.74 19.344 12 19.344C16.971 19.344 21 16.224 21 12.326C21 8.428 16.971 5.308 12 5.308C12 4.195 12 3 12 3Z" fill="#191919"/></svg>
                    <span>ê³µìœ í•˜ê³  ê¸°íšŒ ì–»ê¸°!</span>
                </button>
            </div>
        </div>

        <div id="game-screen" class="screen flex-col h-full">
             <div class="flex justify-between items-center mb-4">
                <div class="font-bold text-lg">ì ìˆ˜: <span id="score" class="font-poppins">0</span></div>
                <div class="font-bold text-lg font-poppins bg-slate-100 rounded-full px-4 py-1">
                    <span id="timer">30</span>ì´ˆ
                </div>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 100%; transition: width 1s linear;"></div>
            </div>
            <div class="flex-grow flex flex-col items-center justify-center">
                <div class="w-full flex items-center justify-center" style="min-height: 80px;">
                    <p id="word" class="text-5xl sm:text-6xl font-bold font-poppins mb-6 text-center"></p>
                </div>
                <div id="freq-info-container" class="h-12 mb-2"></div>
                <div id="options" class="w-full space-y-3"></div>
            </div>
        </div>
        
        <div id="end-screen" class="screen flex-col h-full justify-center text-center">
            <h2 class="text-2xl font-bold text-slate-500">ê²Œì„ ì¢…ë£Œ!</h2>
            <p class="text-lg mt-2">ìµœì¢… ì ìˆ˜</p>
            <p id="final-score" class="text-8xl font-bold font-poppins my-4 gradient-text"></p>
            
            <div id="email-form-container" class="w-full bg-slate-100 p-4 rounded-lg">
                <p class="font-bold mb-2">ë­í‚¹ì´ ìë™ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!<br/>ì¶œì‹œ ì•Œë¦¼ & ê²½í’ˆ ì´ë²¤íŠ¸ì— ì°¸ì—¬í•˜ì„¸ìš”!</p>
                <input type="email" id="email-input" placeholder="ì´ë©”ì¼ ë‚¨ê¸°ê¸° (ì„ íƒì‚¬í•­)" class="w-full p-3 border-2 border-slate-300 rounded-md text-center mt-2 focus:border-purple-500 focus:ring-purple-500 transition">
                <button id="submit-email-btn" class="w-full py-3 mt-3 text-lg font-bold text-white rounded-lg btn-primary">ì´ë©”ì¼ ì œì¶œ</button>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <button id="kakao-share-btn-end" class="flex-1 py-3 bg-[#FEE500] text-[#191919] font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-transform duration-200 flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 3C7.029 3 3 6.12 3 10.018C3 12.33 4.348 14.37 6.428 15.657L5.21 20.211C5.122 20.548 5.421 20.845 5.76 20.755L11.234 19.311C11.484 19.333 11.74 19.344 12 19.344C16.971 19.344 21 16.224 21 12.326C21 8.428 16.971 5.308 12 5.308C12 4.195 12 3 12 3Z" fill="#191919"/></svg>
                    <span>ê³µìœ í•˜ê³  í•œ íŒ ë”!</span>
                </button>
                <button id="back-to-start-btn" class="flex-1 py-3 bg-slate-200 text-slate-800 font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 hover:bg-slate-300 transition-all duration-200">
                    ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        </div>
    </div>

    <div id="alert-modal-backdrop" class="modal-backdrop"></div>
    <div id="alert-modal" class="modal w-11/12 max-w-sm bg-white rounded-2xl shadow-lg p-6 text-center">
        <p id="alert-modal-message" class="text-lg font-semibold mb-6"></p>
        <button id="close-alert-modal-btn" class="w-full py-3 text-lg font-bold text-white rounded-lg btn-primary">í™•ì¸</button>
    </div>

    <script src="/__/firebase/9.6.1/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-auth-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-functions-compat.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script type="module">
        const auth = firebase.auth();
        const db = firebase.firestore();
        const app = firebase.app();
        const functions = app.functions('asia-northeast3');  

        const isNicknameAvailable = functions.httpsCallable('isNicknameAvailable');
        const getKakaoKey = functions.httpsCallable('getKakaoKey');
        const checkAttempts = functions.httpsCallable('checkAttempts');
        const recordAttempt = functions.httpsCallable('recordAttempt');

        const ui = {
            screens: { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), end: document.getElementById('end-screen') },
            startBtn: document.getElementById('start-btn'),
            shareForChanceBtn: document.getElementById('share-for-chance-btn'),
            startNicknameInput: document.getElementById('start-nickname-input'),
            nicknameLabel: document.getElementById('nickname-label'),
            scoreEl: document.getElementById('score'),
            timerEl: document.getElementById('timer'),
            progressBar: document.getElementById('progress-bar'),
            wordEl: document.getElementById('word'),
            optionsEl: document.getElementById('options'),
            freqInfoContainer: document.getElementById('freq-info-container'),
            finalScoreEl: document.getElementById('final-score'),
            emailFormContainer: document.getElementById('email-form-container'),
            emailInput: document.getElementById('email-input'),
            submitEmailBtn: document.getElementById('submit-email-btn'),
            backToStartBtn: document.getElementById('back-to-start-btn'),
            leaderboardList: document.getElementById('leaderboard-list'),
            challengeWeekInfoEl: document.getElementById('challenge-week-info'),
            alertModal: { backdrop: document.getElementById('alert-modal-backdrop'), modal: document.getElementById('alert-modal'), message: document.getElementById('alert-modal-message'), closeBtn: document.getElementById('close-alert-modal-btn') }
        };

        let score, timer, timerInterval, currentWordIndex, nickname, gameStartTime, currentChallengeWeek;
        let shuffledWords = [];
        let isAnswerable = true;
        let isPollingForShare = false;
        
        let audioCtx;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) { console.warn('Web Audio API is not supported in this browser'); }

        function playSound(type) { if (!audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01); if (type === 'correct') { o.type = 'sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime); } else { o.type = 'square'; o.frequency.setValueAtTime(200, audioCtx.currentTime); } o.start(audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2); o.stop(audioCtx.currentTime + 0.2); }
        function showCustomAlert(message) { ui.alertModal.message.textContent = message; ui.alertModal.modal.style.display = 'block'; ui.alertModal.backdrop.style.display = 'block'; }
        function closeCustomAlert() { ui.alertModal.modal.style.display = 'none'; ui.alertModal.backdrop.style.display = 'none'; }
        function switchScreen(screenName) { Object.values(ui.screens).forEach(s => s.classList.remove('active')); ui.screens[screenName].classList.add('active'); }
        function adjustFontSize(el, i, m=10, p=20) { el.style.fontSize = `${i}px`; let c=i; const w = el.parentElement.clientWidth-p; while (el.scrollWidth > w && c>m) { c--; el.style.fontSize = `${c}px`; } }

        async function initGame() {
            nickname = ui.startNicknameInput.value.trim();
            if (!ui.startNicknameInput.disabled) {
                if (nickname.length < 2 || nickname.length > 10) {
                    return showCustomAlert('ë‹‰ë„¤ì„ì€ 2ì ì´ìƒ 10ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                }
                ui.startBtn.disabled = true;
                ui.startBtn.textContent = 'ë‹‰ë„¤ì„ í™•ì¸ ì¤‘...';
                try {
                    const result = await isNicknameAvailable({ nickname });
                    if (!result.data.isAvailable) {
                        showCustomAlert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
                        ui.startBtn.disabled = false;
                        ui.startBtn.textContent = 'ë„ì „ ì‹œì‘!';
                        return;
                    }
                    localStorage.setItem('sudanbiNickname', nickname);
                    checkStoredNickname(); // ë‹‰ë„¤ì„ ì €ì¥ í›„ UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                } catch (error) {
                    console.error("Nickname check error:", error);
                    showCustomAlert(error.message || 'ë‹‰ë„¤ì„ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    ui.startBtn.disabled = false;
                    ui.startBtn.textContent = 'ë„ì „ ì‹œì‘!';
                    return;
                }
            }
            ui.startBtn.disabled = true;
            ui.startBtn.textContent = 'ê¸°íšŒ í™•ì¸ ì¤‘...';
            try {
                const attemptResult = await checkAttempts();
                if (!attemptResult.data.canPlay) {
                    showCustomAlert('ì˜¤ëŠ˜ì€ ë” ì´ìƒ ë„ì „í•  ìˆ˜ ì—†ì–´ìš”! ë‚´ì¼ ë‹¤ì‹œ ë§Œë‚˜ìš”.');
                    await checkPlayChance();
                    return;
                }
            } catch (error) {
                console.error("Error checking attempts:", error);
                showCustomAlert('ë„ì „ ê¸°íšŒ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                ui.startBtn.disabled = false;
                ui.startBtn.textContent = 'ë„ì „ ì‹œì‘!';
                return;
            }
            try {
                ui.startBtn.textContent = 'ê²Œì„ ì‹œì‘ ì¤‘...';
                await recordAttempt();
                const wordsForThisWeek = await getWordsForCurrentWeek();
                if (!wordsForThisWeek || wordsForThisWeek.length === 0) {
                    throw new Error(`ì´ë²ˆ ${currentChallengeWeek}ì£¼ì°¨ ì±Œë¦°ì§€ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                }
                score = 0;
                timer = 30;
                currentWordIndex = 0;
                ui.scoreEl.textContent = score;
                ui.timerEl.textContent = timer;
                shuffledWords = [...wordsForThisWeek].sort(() => 0.5 - Math.random());
                gameStartTime = Date.now();
                switchScreen('game');
                loadNextWord();
                startTimer();
            } catch (error) {
                console.error("Game start/record error:", error);
                showCustomAlert(error.message || 'ê²Œì„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                await checkPlayChance();
            }
        }
        
        function getCurrentChallengeWeek() { const s = new Date('2025-09-01T00:00:00+09:00'), n = new Date(), t = n.getTime()-s.getTime(); return t<0?1:Math.floor(t/(6048e5))+1; }

        async function getWordsForCurrentWeek() {
            currentChallengeWeek = getCurrentChallengeWeek();
            const weekKey = `Week ${currentChallengeWeek}`;
            try {
                const seasonDoc = await db.collection("seasons").doc("season1").get();
                if (seasonDoc.exists) {
                    return seasonDoc.data()[weekKey] || [];
                }
                return [];
            } catch (error) {
                console.error("Error getting words: ", error);
                throw new Error("ë‹¨ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function startTimer() {
            ui.progressBar.style.width = '100%';
            ui.progressBar.style.transition = `width ${timer}s linear`;
            requestAnimationFrame(() => { ui.progressBar.style.width = '0%'; });
            timerInterval = setInterval(() => {
                timer--;
                ui.timerEl.textContent = timer;
                if (timer <= 0) endGame();
            }, 1000);
        }

        function loadNextWord() {
            isAnswerable = true;
            ui.freqInfoContainer.innerHTML = '';
            if (currentWordIndex >= shuffledWords.length) {
                currentWordIndex = 0;
                shuffledWords.sort(() => 0.5 - Math.random());
            }
            const wordData = shuffledWords[currentWordIndex];
            ui.wordEl.textContent = wordData.ë‹¨ì–´;
            adjustFontSize(ui.wordEl, window.innerWidth < 640 ? 48 : 60, 24);
            ui.optionsEl.innerHTML = '';
            [wordData.ì •ë‹µ, wordData.ì˜¤ë‹µ1, wordData.ì˜¤ë‹µ2, wordData.ì˜¤ë‹µ3]
                .sort(() => 0.5 - Math.random())
                .forEach(option => {
                    const btn = document.createElement('button');
                    btn.textContent = option;
                    btn.className = 'w-full p-4 border-2 border-slate-200 rounded-lg text-xl transition duration-200 option-btn';
                    btn.onclick = () => handleAnswer(btn, option, wordData.ì •ë‹µ, wordData.ì—­ëŒ€_ë¹ˆë„);
                    ui.optionsEl.appendChild(btn);
                    adjustFontSize(btn, 20, 14, 32);
                });
            currentWordIndex++;
        }

        function handleAnswer(button, selected, correct, freq) {
            if (!isAnswerable) return;
            isAnswerable = false;
            if (selected === correct) {
                playSound('correct');
                score += 10;
                ui.scoreEl.textContent = score;
                button.classList.add('correct');
            } else {
                playSound('incorrect');
                button.classList.add('incorrect');
                Array.from(ui.optionsEl.children).forEach(btn => {
                    if (btn.textContent === correct) btn.classList.add('correct');
                });
            }
            ui.freqInfoContainer.innerHTML = `<div class="freq-info text-center bg-slate-100 p-2 rounded-md text-slate-600 font-semibold">ğŸ“Š ì—­ëŒ€ ${freq}íšŒ ì¶œì œ</div>`;
            setTimeout(() => ui.freqInfoContainer.querySelector('.freq-info')?.classList.add('visible'), 10);
            setTimeout(() => { if (timer > 0) loadNextWord(); }, 800);
        }

        async function endGame() {
            clearInterval(timerInterval);
            ui.progressBar.style.transition = 'none';
            ui.finalScoreEl.textContent = score;
            const elapsedTime = Date.now() - gameStartTime;
            const user = auth.currentUser;
            if (!user) return switchScreen('end');
            const userScoreRef = db.collection("scores").doc(user.uid);
            try {
                const docSnap = await userScoreRef.get();
                if (!docSnap.exists || score > (docSnap.data().score || 0) || (score === docSnap.data().score && elapsedTime < (docSnap.data().elapsedTime || Infinity))) {
                    await userScoreRef.set({
                        uid: user.uid, name: nickname, score: score, elapsedTime: elapsedTime,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }
            } catch (error) {
                console.error("Error saving score: ", error);
                showCustomAlert('ì ìˆ˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            switchScreen('end');
        }

        async function submitEmail() {
            const email = ui.emailInput.value.trim();
            if (!email) return showCustomAlert('ì´ë²¤íŠ¸ì— ì°¸ì—¬í•˜ì‹œë ¤ë©´ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showCustomAlert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            ui.submitEmailBtn.disabled = true;
            ui.submitEmailBtn.textContent = 'ì œì¶œ ì¤‘...';
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('ì‚¬ìš©ì ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                await db.collection("emails").doc(user.uid).set({
                    name: nickname, email: email, score: score,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showCustomAlert('ì´ë²¤íŠ¸ ì°¸ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                ui.emailFormContainer.style.display = 'none';
            } catch (error) {
                console.error("Email submission error:", error);
                if (error.code === 'permission-denied') {
                    showCustomAlert('ì´ë¯¸ ì´ë²¤íŠ¸ì— ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤!');
                    ui.emailFormContainer.style.display = 'none';
                } else {
                    showCustomAlert('ì´ë©”ì¼ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            } finally {
                ui.submitEmailBtn.disabled = false;
                ui.submitEmailBtn.textContent = 'ì´ë©”ì¼ ì œì¶œ';
            }
        }

        function displayLeaderboard(scores) {
            ui.leaderboardList.innerHTML = '';
            if (!scores || scores.length === 0) {
                ui.leaderboardList.innerHTML = '<li class="text-center text-slate-400 p-4">ì•„ì§ ë“±ë¡ëœ ì ìˆ˜ê°€ ì—†ì–´ìš”.<br>ì²« ë²ˆì§¸ ì±”í”¼ì–¸ì´ ë˜ì–´ë³´ì„¸ìš”!</li>';
                return;
            }
            scores.forEach((data, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-slate-100 p-3 rounded-lg';
                const timeDisplay = data.elapsedTime ? `<span class="text-xs text-slate-500 font-poppins">${(data.elapsedTime / 1000).toFixed(2)}ì´ˆ</span>` : '';
                li.innerHTML = `
                    <div class="flex items-center">
                        <span class="rank font-bold text-sm bg-slate-300 text-slate-600 rounded-full w-6 h-6 flex items-center justify-center mr-3">${index + 1}</span>
                        <span class="font-semibold text-slate-700">${data.name}</span>
                    </div>
                    <div class="text-right">
                        <span class="font-bold font-poppins text-purple-600">${data.score}ì </span>
                        ${timeDisplay}
                    </div>
                `;
                ui.leaderboardList.appendChild(li);
            });
        }

        function subscribeToLeaderboard() {
            db.collection("scores").orderBy("score", "desc").orderBy("elapsedTime", "asc").limit(10)
              .onSnapshot((querySnapshot) => {
                const scores = querySnapshot.docs.map(doc => doc.data());
                displayLeaderboard(scores);
              }, (error) => {
                console.error("Leaderboard subscription error: ", error);
                ui.leaderboardList.innerHTML = `<li class="text-center text-slate-400 p-4 text-red-500">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>`;
              });
        }
        
        async function shareToKakao(isForChance = false) {
            if (!Kakao.isInitialized()) {
                try {
                    const result = await getKakaoKey();
                    Kakao.init(result.data.key);
                } catch (error) {
                    return showCustomAlert('ê³µìœ  ê¸°ëŠ¥ì„ ì¤€ë¹„í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            if (isForChance) {
                 const user = auth.currentUser;
                 if(user) {
                    try {
                        const attemptDocRef = db.collection('attempts').doc(user.uid);
                        await attemptDocRef.update({ hasSharedToday: true });
                        // ì„±ê³µì ìœ¼ë¡œ DB ì—…ë°ì´íŠ¸ í›„ í´ë§ ì‹œì‘
                        pollForShareSuccess();
                    } catch (error) {
                        console.error("Error pre-updating share status:", error);
                        showCustomAlert('ê³µìœ  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                }
            }

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'ìˆ˜ë‹¨ë¹„ ë‹¨ì–´ ì±Œë¦°ì§€',
                    description: isForChance ? 'ì¹œêµ¬ì•¼, ê°™ì´ ìˆ˜ëŠ¥ ì˜ë‹¨ì–´ í€´ì¦ˆ í’€ì!' : `${nickname || 'ë‚˜'}ì˜ ì ìˆ˜ëŠ” ${score}ì ! ë‹¹ì‹ ì˜ ì–´íœ˜ë ¥ì— ë„ì „í•˜ì„¸ìš”!`,
                    imageUrl: 'https://cdn.imweb.me/upload/S20250512bc351e1543759/78f771da220ea.png',
                    link: { mobileWebUrl: window.location.href, webUrl: window.location.href },
                },
                buttons: [{ title: 'ê²Œì„í•˜ëŸ¬ ê°€ê¸°', link: { mobileWebUrl: window.location.href, webUrl: window.location.href }}]
            });
        }

        function pollForShareSuccess() {
            if (isPollingForShare) return;
            isPollingForShare = true;

            let attempts = 0;
            const maxAttempts = 10; // 20ì´ˆ ë™ì•ˆ í™•ì¸ (2ì´ˆ ê°„ê²©)
            const pollInterval = setInterval(async () => {
                attempts++;
                const user = auth.currentUser;
                if (!user || attempts > maxAttempts) {
                    clearInterval(pollInterval);
                    isPollingForShare = false;
                    return;
                }

                try {
                    const attemptDoc = await db.collection('attempts').doc(user.uid).get();
                    if (attemptDoc.exists && attemptDoc.data().hasSharedToday) {
                        clearInterval(pollInterval);
                        isPollingForShare = false;
                        showCustomAlert('ê³µìœ  ì™„ë£Œ! ì¶”ê°€ ë„ì „ ê¸°íšŒë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.');
                        await checkPlayChance();
                    }
                } catch(e) {
                    console.error("Polling error", e);
                }

            }, 2000);
        }

        function checkStoredNickname() {
            const storedNickname = localStorage.getItem('sudanbiNickname');
            if (storedNickname) {
                ui.startNicknameInput.value = storedNickname;
                nickname = storedNickname;
                ui.startNicknameInput.disabled = true;
                ui.nicknameLabel.textContent = `${storedNickname}ë‹˜, ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”!`;
            } else {
                 ui.startNicknameInput.disabled = false;
                 ui.nicknameLabel.textContent = `ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!`;
            }
        }

        function setChallengeWeekInfo() { currentChallengeWeek = getCurrentChallengeWeek(); const m = new Date().getMonth() + 1; ui.challengeWeekInfoEl.textContent = `ğŸ† ${m}ì›” ${currentChallengeWeek}ì£¼ì°¨ ì±Œë¦°ì§€ ì§„í–‰ ì¤‘ ğŸ†`; }
        
        async function checkPlayChance() {
            const user = auth.currentUser;
            if (!user) return;
            ui.startBtn.disabled = true;
            ui.startBtn.textContent = 'ê¸°íšŒ í™•ì¸ ì¤‘...';
            try {
                const result = await checkAttempts();
                const canPlay = result.data.canPlay;
                
                if (canPlay) {
                    ui.startBtn.disabled = false;
                    ui.startBtn.classList.remove('hidden');
                    ui.shareForChanceBtn.classList.add('hidden');
                    ui.startBtn.textContent = 'ë„ì „ ì‹œì‘!';
                } else {
                    if (result.data.reason === "Share to get another chance.") {
                        ui.startBtn.classList.add('hidden');
                        ui.shareForChanceBtn.classList.remove('hidden');
                    } else {
                        ui.startBtn.classList.remove('hidden');
                        ui.shareForChanceBtn.classList.add('hidden');
                        ui.startBtn.disabled = true;
                        ui.startBtn.textContent = 'ì˜¤ëŠ˜ì˜ ê¸°íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”';
                    }
                }
            } catch (error) {
                console.error("Error in checkPlayChance:", error);
                ui.startBtn.disabled = true;
                ui.startBtn.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
            }
        }

        ui.backToStartBtn.addEventListener('click', () => { switchScreen('start'); checkPlayChance(); });
        ui.startBtn.addEventListener('click', initGame);
        ui.submitEmailBtn.addEventListener('click', submitEmail);
        ui.alertModal.closeBtn.addEventListener('click', closeCustomAlert);
        ui.alertModal.backdrop.addEventListener('click', closeCustomAlert);
        ui.shareForChanceBtn.addEventListener('click', () => shareToKakao(true));
        document.getElementById('kakao-share-btn-end').addEventListener('click', () => shareToKakao(false));

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("Anonymous user signed in:", user.uid);
                try {
                    const emailDocRef = db.collection("emails").doc(user.uid);
                    const docSnap = await emailDocRef.get();
                    if (docSnap.exists) { 
                        ui.emailFormContainer.style.display = 'none';
                    } else {
                        ui.emailFormContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Error checking email record:", error);
                }
                setChallengeWeekInfo();
                subscribeToLeaderboard();
                checkStoredNickname();
                await checkPlayChance();
            } else {
                auth.signInAnonymously().catch((error) => console.error("Anonymous sign-in failed:", error));
            }
        });
    </script>
</body>
</html>